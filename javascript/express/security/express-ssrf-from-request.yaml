rules:
  - id: express-ssrf-from-request
    message: >-
      $EXPREQ Request body and request parameter data is untrustworthy. Passing it to a request constructing function can lead to Server-Side Request Forgery (SSRF) if the data isn't sanitized properly beforehand
    severity: WARNING
    languages: [javascript, typescript]
    metadata:
      cwe: "CWE-918: Server-Side Request Forgery (SSRF)"
      owasp:
        - "A10:2021 - Server-Side Request Forgery (SSRF)"
      category: security
      technology:
        - express
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern-inside: function ... ($REQ, $RES) {...}
              - pattern-inside: function ... ($REQ, $RES, $NEXT) {...}
              - pattern-inside: $APP.get(..., function $FUNC($REQ, $RES) {...})
              - pattern-inside: $APP.get(..., function $FUNC($REQ, $RES, $NEXT) {...})
              - pattern-inside: $APP.post(..., function $FUNC($REQ, $RES) {...})
              - pattern-inside: $APP.post(..., function $FUNC($REQ, $RES, $NEXT) {...})
              - pattern-inside: $APP.put(..., function $FUNC($REQ, $RES) {...})
              - pattern-inside: $APP.put(..., function $FUNC($REQ, $RES, $NEXT) {...})
              - pattern-inside: $APP.head(..., function $FUNC($REQ, $RES) {...})
              - pattern-inside: $APP.head(..., function $FUNC($REQ, $RES, $NEXT) {...})
              - pattern-inside: $APP.delete(..., function $FUNC($REQ, $RES) {...})
              - pattern-inside: $APP.delete(..., function $FUNC($REQ, $RES, $NEXT) {...})
              - pattern-inside: $APP.options(..., function $FUNC($REQ, $RES) {...})
              - pattern-inside: $APP.options(..., function $FUNC($REQ, $RES, $NEXT) {...})
          - pattern: $REQ

    pattern-sinks:
      - patterns:
          - pattern-inside: |
              $IREQ = require('request')
              ...
          - pattern-either:
              - pattern: $IREQ.get(...)
              - pattern: $IREQ.post(...)
              - pattern: $IREQ.put(...)
              - pattern: $IREQ.patch(...)
              - pattern: $IREQ.del(...)
              - pattern: $IREQ.delete(...)
              - pattern: $IREQ.head(...)
